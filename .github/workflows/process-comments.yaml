name: Process Academic Reviews
on:
  discussion_comment:
    types: [created]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # æ­¥éª¤1ï¼šåˆå§‹åŒ–ç¯å¢ƒ
      - name: Setup Environment
        id: setup
        env:
          COMMENT_BODY: ${{ toJson(github.event.comment.body) }}
        run: |
          # å­˜å‚¨åŸå§‹è¯„è®º
          echo "$COMMENT_BODY" | jq -r . > raw_comment.txt
          
          # æ£€æµ‹è¯„è®ºç±»å‹
          if grep -q '^!course-review' raw_comment.txt; then
            echo "TYPE=course" >> $GITHUB_OUTPUT
            TARGET_FILE="docs/college/course.md"
          elif grep -q '^!contribute' raw_comment.txt; then
            echo "TYPE=major" >> $GITHUB_OUTPUT
            TARGET_FILE="docs/college/major.md"
          else
            echo "::error::æœªè¯†åˆ«è¯„è®ºç±»å‹ï¼Œè¯·ä½¿ç”¨ !course-review æˆ– !contribute å¼€å¤´"
            exit 1
          fi
          echo "TARGET_FILE=${TARGET_FILE}" >> $GITHUB_OUTPUT

      # æ­¥éª¤2ï¼šå¤„ç†è¯¾ç¨‹è¯„ä»·
      - name: Process Course Review
        if: steps.setup.outputs.TYPE == 'course'
        run: |
          # æå–å„å­—æ®µå†…å®¹
          extract_field() {
            sed -n "/^$1:/s/^$1://p" raw_comment.txt | 
            sed -e 's/^[ \t]*//' -e 's/[ \t]*$//' |
            tr -d '\r\n'
          }

          # ç”Ÿæˆæ ‡å‡†æ ¼å¼
          printf "\n- %s %s\n  å¸ˆèµ„: %s\n  ç®€è¯„ï¼š%s\n  äººæ•°ï¼š%s\n  è¯¾å ‚ä½“éªŒï¼š%s\n  è¯¾ç¨‹éš¾åº¦ï¼š%s\n  åº”ç”¨ä»·å€¼ï¼š%s\n  è€ƒæ ¸æƒ…å†µï¼š%s\n  æ›´æ–°æ—¶é—´ï¼š%s" \
            "$(extract_field 'è¯¾ç¨‹åç§°')" \
            "$(extract_field 'è¯„åˆ†')" \
            "$(extract_field 'å¸ˆèµ„')" \
            "$(extract_field 'ç®€è¯„')" \
            "$(extract_field 'äººæ•°')" \
            "$(extract_field 'è¯¾å ‚ä½“éªŒ')" \
            "$(extract_field 'è¯¾ç¨‹éš¾åº¦')" \
            "$(extract_field 'åº”ç”¨ä»·å€¼')" \
            "$(extract_field 'è€ƒæ ¸æƒ…å†µ')" \
            "$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')" \
            >> ${{ steps.setup.outputs.TARGET_FILE }}

      # æ­¥éª¤3ï¼šå¤„ç†ä¸“ä¸šè¯„ä»·
      - name: Process Major Review
        if: steps.setup.outputs.TYPE == 'major'
        run: |
          # æ¸…ç†åŸå§‹å†…å®¹
          PROCESSED=$(
            sed -E '
              s/!contribute//g;
              /^[[:space:]]*$/d;
              s/^[[:space:]]+//;
              s/[[:space:]]+$//
            ' raw_comment.txt | 
            base64 -w0
          )
          
          # å†™å…¥ç›®æ ‡æ–‡ä»¶
          DECODED=$(echo "$PROCESSED" | base64 -d)
          printf "\n\n---\n**è´¡çŒ®äº $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')**\n\n%s" \
            "${DECODED}" \
            >> ${{ steps.setup.outputs.TARGET_FILE }}

      # æ­¥éª¤4ï¼šåˆ›å»ºPR
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update ${{ steps.setup.outputs.TYPE }} review"
          title: "ğŸ“ Update ${{ steps.setup.outputs.TYPE }} reviews"
          body: |
            è‡ªåŠ¨åŒ–æ›´æ–°æ¥è‡ªè®¨è®ºåŒºçš„è¯„ä»·ï¼š
            - ç±»å‹ï¼š${{ steps.setup.outputs.TYPE }}
            - è§¦å‘è¯„è®ºï¼š#${{ github.event.comment.id }}
            - æ›´æ–°æ–‡ä»¶ï¼š${{ steps.setup.outputs.TARGET_FILE }}
          branch: "review-update-${{ github.run_id }}"