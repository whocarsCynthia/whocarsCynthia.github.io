name: Process Giscus Contributions
on:
  discussion_comment:
    types: [created]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # æ­¥éª¤1ï¼šå®‰å…¨è§£æDiscussionè¯„è®º
      - name: Parse Comment
        id: parse
        env:
          COMMENT_BODY: ${{ toJson(github.event.comment.body) }}
        run: |
          # å®‰å…¨å†™å…¥äº‹ä»¶æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶
          echo "$COMMENT_BODY" > comment_body.json
          
          # ä½¿ç”¨jqè§£æJSONå†…å®¹
          if grep -q '!contribute' comment_body.json; then
            CONTENT=$(jq -r 'gsub("!contribute"; "")' comment_body.json | \
                     sed -e 's/"/\\"/g' -e 's/`/\\`/g')
            echo "CONTENT=${CONTENT}" >> $GITHUB_OUTPUT
            echo "HAS_CONTRIBUTION=true" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤2ï¼šæ›´æ–°Markdownæ–‡ä»¶
      - name: Update Markdown
        if: steps.parse.outputs.HAS_CONTRIBUTION == 'true'
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M")
          echo -e "\n\n---\n**è´¡çŒ®äº ${TIMESTAMP}**\n\n${{ steps.parse.outputs.CONTENT }}" \
            >> docs/college/major.md

      # æ­¥éª¤3ï¼šè‡ªåŠ¨åˆ›å»ºPR
      - name: Create PR
        if: steps.parse.outputs.HAS_CONTRIBUTION == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add user contribution from Discussion #${{ github.event.discussion.number }}"
          title: "ğŸ“ Update from Discussion #${{ github.event.discussion.number }}"
          body: |
            Automated update triggered by:
            - Discussion: #${{ github.event.discussion.number }}
            - Comment ID: ${{ github.event.comment.id }}
            Original content:
            ```markdown
            ${{ steps.parse.outputs.CONTENT }}
            ```
          branch: "discussion-contrib-${{ github.event.comment.id }}"