name: Process Giscus Contributions
on:
  discussion_comment:
    types: [created]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 步骤1：安全解析Discussion评论
      - name: Parse Comment
        id: parse
        env:
          COMMENT_BODY: ${{ toJson(github.event.comment.body) }}
        run: |
          # 写入原始内容到文件
          echo "$COMMENT_BODY" | jq -r . > raw_comment.txt
          
          # 处理内容并Base64编码
          PROCESSED=$(sed -e 's/!contribute//g' -e '/^$/d' raw_comment.txt | base64 -w0)
          
          # 安全设置输出
          echo "CONTENT=${PROCESSED}" >> $GITHUB_OUTPUT
          echo "HAS_CONTRIBUTION=true" >> $GITHUB_OUTPUT

      # 步骤2：更新Markdown文件
      - name: Update Markdown
        if: steps.parse.outputs.HAS_CONTRIBUTION == 'true'
        run: |
          # Base64解码内容
          DECODED=$(echo "${{ steps.parse.outputs.CONTENT }}" | base64 -d)
          
          # 写入文件（带时间戳和分隔线）
          TIMESTAMP=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M")
          printf "\n\n---\n**贡献于 ${TIMESTAMP}**\n\n%s" "${DECODED}" \
          >> docs/college/major.md
          
      # 步骤3：创建PR（保持不变）
      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update from discussion comment"
          branch: "discussion-update-${{ github.run_id }}"