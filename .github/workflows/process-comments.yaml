name: Process Giscus Contributions
on:
  issue_comment:
    types: [created]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # æ­¥éª¤1ï¼šè§£æè¯„è®ºå†…å®¹
      - name: Parse Comment
        id: parse
        run: |
          if [[ "${{ github.event.comment.body }}" == *"!contribute"* ]]; then
            # æå–æœ‰æ•ˆå†…å®¹å¹¶è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
            CONTENT=$(echo "${{ github.event.comment.body }}" | 
                      sed -e 's/!contribute//g' -e 's/"/\\"/g' -e 's/`/\\`/g')
            echo "CONTENT=${CONTENT}" >> $GITHUB_OUTPUT
            echo "HAS_CONTRIBUTION=true" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤2ï¼šæ›´æ–°Markdownæ–‡ä»¶
      - name: Update Markdown
        if: steps.parse.outputs.HAS_CONTRIBUTION == 'true'
        run: |
          # æ·»åŠ åˆ†éš”çº¿å’Œè´¡çŒ®å†…å®¹
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M")
          echo -e "\n\n---\n**è´¡çŒ®äº ${TIMESTAMP}**\n\n${{ steps.parse.outputs.CONTENT }" \
            >> docs/college/major.md

      # æ­¥éª¤3ï¼šè‡ªåŠ¨åˆ›å»ºPR
      - name: Create PR
        if: steps.parse.outputs.HAS_CONTRIBUTION == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add user contribution from Giscus comment"
          title: "ğŸ“ Update from Giscus contribution"
          body: "Automated update triggered by comment #${{ github.event.comment.id }}"
          branch: "giscus-contribution-${{ github.run_id }}"

  # æ­¥éª¤4ï¼šè‡ªåŠ¨éƒ¨ç½²ï¼ˆæ·»åŠ æ–°jobï¼‰
  deploy:
    needs: process
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged
    steps:
      - uses: actions/checkout@v4
      - run: echo "Triggering site rebuild..."